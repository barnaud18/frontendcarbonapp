<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propriedades Cadastradas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <h1>Propriedades Cadastradas</h1>
        
        <div class="mb-4 text-end">
            <a href="{{ url_for('index') }}" class="btn btn-primary">Voltar para Calculadora</a>
        </div>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{% if category == 'error' %}danger{% else %}{{ category }}{% endif %}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        {% if propriedades %}
            <div class="row">
                <div class="col-12">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="card-title">Lista de Propriedades</h2>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Tamanho Total (ha)</th>
                                            <th>Área Agrícola (ha)</th>
                                            <th>Num. Bovinos</th>
                                            <th>Emissões Totais (tCO₂e)</th>
                                            <th>Créditos Potenciais (tCO₂e)</th>
                                            <th>Data de Registro</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for prop in propriedades %}
                                            <tr>
                                                <td>{{ prop.nome }}</td>
                                                <td>{{ prop.tamanho_total }}</td>
                                                <td>{{ prop.agricultura.area_agricola if prop.agricultura else 'N/A' }}</td>
                                                <td>{{ prop.pecuaria.num_bovinos if prop.pecuaria else 'N/A' }}</td>
                                                <td>{{ "%.2f"|format(prop.emissao.total_emissao/1000) if prop.emissao else 'N/A' }}</td>
                                                <td>{{ "%.2f"|format(prop.emissao.potencial_credito) if prop.emissao and prop.emissao.potencial_credito else 'N/A' }}</td>
                                                <td>{{ prop.data_registro.strftime('%d/%m/%Y') }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="card-title">Emissões Totais por Propriedade</h2>
                            <canvas id="emissionsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-body">
                            <h2 class="card-title">Potencial de Créditos de Carbono</h2>
                            <canvas id="creditsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                // Setup emission chart data
                const emissionsCtx = document.getElementById('emissionsChart').getContext('2d');
                const emissionsData = {
                    labels: [
                        {% for prop in propriedades %}
                            {% if prop.emissao %}
                                '{{ prop.nome }}',
                            {% endif %}
                        {% endfor %}
                    ],
                    datasets: [{
                        label: 'Emissões Totais (tCO₂e/ano)',
                        data: [
                            {% for prop in propriedades %}
                                {% if prop.emissao %}
                                    {{ prop.emissao.total_emissao/1000 }},
                                {% endif %}
                            {% endfor %}
                        ],
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                };
                
                // Create emissions chart
                new Chart(emissionsCtx, {
                    type: 'bar',
                    data: emissionsData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas CO₂e/ano'
                                }
                            }
                        }
                    }
                });
                
                // Setup credits chart data
                const creditsCtx = document.getElementById('creditsChart').getContext('2d');
                const creditsData = {
                    labels: [
                        {% for prop in propriedades %}
                            {% if prop.emissao and prop.emissao.potencial_credito %}
                                '{{ prop.nome }}',
                            {% endif %}
                        {% endfor %}
                    ],
                    datasets: [{
                        label: 'Créditos Potenciais (tCO₂e/ano)',
                        data: [
                            {% for prop in propriedades %}
                                {% if prop.emissao and prop.emissao.potencial_credito %}
                                    {{ prop.emissao.potencial_credito }},
                                {% endif %}
                            {% endfor %}
                        ],
                        backgroundColor: 'rgba(75, 192, 192, 0.7)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                };
                
                // Create credits chart
                new Chart(creditsCtx, {
                    type: 'bar',
                    data: creditsData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Toneladas CO₂e/ano'
                                }
                            }
                        }
                    }
                });
            </script>
        {% else %}
            <div class="alert alert-info">
                <h4 class="alert-heading">Nenhuma propriedade cadastrada!</h4>
                <p>Volte para a calculadora e cadastre uma propriedade para visualizar seus dados aqui.</p>
            </div>
        {% endif %}
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>